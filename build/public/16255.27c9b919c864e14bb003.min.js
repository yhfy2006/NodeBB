(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[16255,73848,6232,33085,34405],{38636:(w,T,m)=>{"use strict";var b,E;b=[m(52473),m(6411),m(26832),m(80083),m(58836),m(60419),m(72513),m(65161),m(93230),m(88518),m(91749),m(40027),m(29930),m(92619),m(49897),m(43103)],E=function(y,v,l,p,h,n,s,i,r,c,d,u,g,x,A,D){const o={initialised:!1,activeAutocomplete:{}};let j=!1,k=null;return $(window).on("action:ajaxify.start",function(){o.destroyAutoComplete(ajaxify.data.roomId),ajaxify.data.template.chats&&(ajaxify.data.roomId&&socket.emit("modules.chats.leave",ajaxify.data.roomId),ajaxify.data.publicRooms&&socket.emit("modules.chats.leavePublic",ajaxify.data.publicRooms.map(t=>t.roomId)))}),o.init=function(){utils.isMobile()||$('.chats-full [data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),socket.emit("modules.chats.enterPublic",ajaxify.data.publicRooms.map(a=>a.roomId));const t=utils.findBootstrapEnvironment();k=$('[component="chat/nav-wrapper"]'),o.initialised||(o.addSocketListeners(),o.addGlobalEventListeners()),l.init(),o.addEventListeners(),o.setActive(ajaxify.data.roomId),(t==="md"||t==="lg"||t==="xl"||t==="xxl")&&o.addHotkeys(),o.initialised=!0;const e=$('[component="chat/message/content"]');if(n.wrapImagesInLinks(e),ajaxify.data.scrollToIndex){n.toggleScrollUpAlert(e);const a=e.find(`[data-index="${ajaxify.data.scrollToIndex-1}"]`);a.length&&e.scrollTop(e.scrollTop()-e.offset().top+a.offset().top)}else n.scrollToBottomAfterImageLoad(e);p.init(),d.fire("action:chat.loaded",$(".chats-full"))},o.addEventListeners=function(){const{roomId:t}=ajaxify.data,e=$('[component="chat/main-wrapper"]'),a=$('[component="chat/message/content"]'),f=y.get("chat/controls");o.addSendHandlers(t,$(".chat-input"),$('.expanded-chat button[data-action="send"]')),o.addPopoutHandler(),o.addActionHandlers(y.get("chat/message/window"),t),o.addManageHandler(t,f.find('[data-action="manage"]')),o.addRenameHandler(t,f.find('[data-action="rename"]')),o.addLeaveHandler(t,f.find('[data-action="leave"]')),o.addDeleteHandler(t,f.find('[data-action="delete"]')),o.addScrollHandler(t,ajaxify.data.uid,a),o.addScrollBottomHandler(t,a),o.addParentHandler(e),o.addCharactersLeftHandler(e),o.addTextareaResizeHandler(e),o.addTypingHandler(e,t),o.addIPHandler(e),o.addCopyTextLinkHandler(e),o.createAutoComplete(t,$('[component="chat/input"]')),o.addUploadHandler({dragDropAreaEl:$(".chats-full"),pasteEl:$('[component="chat/input"]'),uploadFormEl:$('[component="chat/upload"]'),uploadBtnEl:$('[component="chat/upload/button"]'),inputEl:$('[component="chat/input"]')}),$('[data-action="close"]').on("click",function(){o.switchChat()}),s.init(t,e),o.addNotificationSettingHandler(t,e),i.init(t,e),o.addPublicRoomSortHandler(),o.addTooltipHandler(e),r.init(e)},o.addPublicRoomSortHandler=function(){app.user.isAdmin&&!utils.isMobile()&&app.loadJQueryUI(()=>{const t=$('[component="chat/public"]');t.sortable({handle:'[component="chat/public/room/sort/handle"]',items:'[component="chat/public/room"]',axis:"y",update:async function(){const e={roomIds:[],scores:[]};t.find("[data-roomid]").each((a,f)=>{e.roomIds.push($(f).attr("data-roomid")),e.scores.push(a)}),await A.put("/chats/sort",e)}})})},o.addTooltipHandler=function(t){utils.isMobile()||(t.find("[data-manual-tooltip]").tooltip({trigger:"manual",animation:!1,placement:"bottom"}).on("mouseenter",function(e){const a=$(e.target);a.hasClass("dropdown-menu")||!!a.parents(".dropdown-menu").length||$(this).tooltip("show")}).on("click mouseleave",function(){$(this).tooltip("hide")}),t.tooltip({selector:'[component="chat/message/controls"] > .btn-group > button',placement:"top",container:"#content",animation:!1,trigger:"hover"}))},o.addNotificationSettingHandler=function(t,e){const a=e.find('[component="chat/notification/setting"]');a.find("[data-value]").on("click",async function(){a.find("i.fa-check").addClass("hidden");const f=$(this);f.find("i.fa-check").removeClass("hidden"),a.find('[component="chat/notification/setting/icon"]').attr("class",`fa ${f.attr("data-icon")}`),await A.put(`/chats/${t}/watch`,{value:f.attr("data-value")})})},o.addParentHandler=function(t){t.off("click",'[component="chat/message/parent"]').on("click",'[component="chat/message/parent"]',function(){const e=$(this);e.find('[component="chat/message/parent/content"]').toggleClass("line-clamp-1"),e.find(".chat-timestamp").toggleClass("hidden"),e.toggleClass("flex-column").toggleClass("flex-row");const a=e.parents('[component="chat/message/content"]');a.length&&n.isAtBottom(a)&&n.scrollToBottom(a)})},o.addUploadHandler=function(t){D.init({dragDropAreaEl:t.dragDropAreaEl,pasteEl:t.pasteEl,uploadFormEl:t.uploadFormEl,uploadBtnEl:t.uploadBtnEl,route:"/api/post/upload",callback:function(e){const a=t.inputEl;let f=a.val();e.forEach(C=>{f=f+(f.endsWith(`
`)?"":`
`)+(C.isImage?"!":"")+`[${C.filename}](${C.url})
`}),a.val(f).trigger("input")}})},o.addIPHandler=function(t){t.off("click",".chat-ip-button").on("click",".chat-ip-button",async function(){const e=$(this);let a=e.attr("data-ip");if(a){navigator.clipboard.writeText(a),e.translateText("[[global:copied]]"),setTimeout(()=>e.text(a),2e3);return}const f=e.parents("[data-mid]").attr("data-mid");({ip:a}=await A.get(`/chats/${ajaxify.data.roomId}/messages/${f}/ip`)),e.text(a).attr("data-ip",a)})},o.addCopyTextLinkHandler=function(t){function e(a,f){navigator.clipboard.writeText(f),a.find("i").addClass("fa-check").removeClass("fa-link"),setTimeout(()=>a.find("i").removeClass("fa-check").addClass("fa-link"),2e3)}t.off("click",'[data-action="copy-link"]').on("click",'[data-action="copy-link"]',function(){const a=$(this),f=a.attr("data-mid");f&&e(a,`${window.location.origin}/message/${f}`)}),t.off("click",'[data-action="copy-text"]').on("click",'[data-action="copy-text"]',function(){const a=$(this),f=a.parents("[data-mid]");f.length&&e(a,f.find('[component="chat/message/body"]').text().trim())})},o.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){const t=y.get("chat/input").val(),e=ajaxify.data.roomId;app.previousUrl&&app.previousUrl.match(/chats/)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){x.openChat(e,ajaxify.data.uid)},!0):(window.history.go(-1),x.openChat(e,ajaxify.data.uid)),$(window).one("action:chat.loaded",function(){y.get("chat/input").val(t)})})},o.addScrollHandler=function(t,e,a){let f=!1,C=a.scrollTop(),S=C;a.off("scroll").on("scroll",utils.debounce(function(){if(parseInt(a.attr("data-ignore-next-scroll"),10)===1){a.removeAttr("data-ignore-next-scroll"),C=a.scrollTop();return}if(n.toggleScrollUpAlert(a),f)return;S=a.scrollTop();const I=S>C?1:-1;C=S;const L=100*(S/(a[0].scrollHeight-a.height())),F=15,B=85;if(!(I===1&&!ajaxify.data.scrollToIndex)&&(L<F&&I===-1||L>B&&I===1)){f=!0;const U=a.children("[data-mid]").not(".new"),N=I>0?U.last():U.first(),M=parseInt(N.attr("data-index"),10)||0;A.get(`/chats/${t}/messages`,{uid:e,start:M,direction:I}).then(W=>{let H=W.messages;if(!H){f=!1;return}if(H=H.filter(function(R){const P=a.find('[component="chat/message"][data-mid="'+R.messageId+'"]');return P.removeClass("new"),!P.length}),!H.length){f=!1;return}n.parseMessage(H,function(R){if(a.attr("data-ignore-next-scroll",1),I>0)R.insertAfter(N),n.onMessagesAddedToDom(R);else{const P=a.scrollTop(),K=a[0].scrollHeight;a.prepend(R),n.onMessagesAddedToDom(R),a.scrollTop(a[0].scrollHeight-K+P)}f=!1})}).catch(g.error)}},100))},o.addScrollBottomHandler=function(t,e){e.parents('[component="chat/message/window"]').find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",function(){ajaxify.data.scrollToIndex&&parseInt(ajaxify.data.roomId,10)===parseInt(t,10)?o.switchChat(t):n.scrollToBottom(e)})},o.addCharactersLeftHandler=function(t){t.find('[component="chat/input"]').on("change keyup paste",function(){n.updateRemainingLength(t)})},o.addTextareaResizeHandler=function(t){const e=t.find('[component="chat/input"]');e.on("input",function(){const a=t.find('[component="chat/message/content"]'),f=n.isAtBottom(a);e.css({height:0}),e.css({height:n.calcAutoTextAreaHeight(e)+"px"}),f&&n.scrollToBottom(a)})},o.addTypingHandler=function(t,e){const a=t.find('[component="chat/input"]');function f(I){A.put(`/chats/${e}/typing`,{typing:I}).catch(g.error)}a.on("focus",()=>a.val()&&f(!0)),a.on("blur",()=>f(!1));let C=0,S=!!a.val();a.on("input",function(){const I=!!a.val();I!==S?(clearTimeout(C),C=0,S=I,f(S)):C||(C=setTimeout(()=>{f(!!a.val()),C=0},5e3))})},o.addActionHandlers=function(t,e){t.on("click","[data-mid] [data-action]",function(){const a=$(this).parents("[data-mid]"),f=a.attr("data-mid"),C=this.getAttribute("data-action");switch($(this).tooltip("dispose"),C){case"reply":n.prepReplyTo(a,t);break;case"edit":n.prepEdit(a,f,e);break;case"delete":n.delete(f,e);break;case"restore":n.restore(f,e);break;case"pin":r.pin(f,e);break;case"unpin":r.unpin(f,e);break}})},o.addHotkeys=function(){v.bind("ctrl+up",function(){const e=$(".chats-list .active").prevAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&o.switchChat(e.attr("data-roomid"))}),v.bind("ctrl+down",function(){const e=$(".chats-list .active").nextAll("[data-roomid]").first();e.length&&e.attr("data-roomid")&&o.switchChat(e.attr("data-roomid"))}),v.bind("up",function(t){const e=y.get("chat/input");if(t.target===e.get(0)&&!e.val()){const a=y.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!a.length)return;const f=a.attr("data-mid");n.prepEdit(a,f,ajaxify.data.roomId)}})},o.addManageHandler=function(t,e){h.init(t,e)},o.addLeaveHandler=function(t,e){e.on("click",function(){u.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="form-text">[[modules:chat.leave-help]]</p>',callback:function(a){a&&A.del(`/chats/${t}/users/${app.user.uid}`,{}).then(()=>{const f=e.parents(".chat-modal");f.length?x.close(f):(o.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(g.error)}})})},o.addDeleteHandler=function(t,e){e.on("click",function(){u.confirm({size:"small",title:"[[modules:chat.delete]]",message:"<p>[[modules:chat.delete-prompt]]</p>",callback:function(a){a&&A.del(`/admin/chats/${t}`,{}).then(()=>{const f=e.parents(".chat-modal");f.length?x.close(f):(o.destroyAutoComplete(t),ajaxify.go("chats"))}).catch(g.error)}})})},o.addRenameHandler=function(t,e){e.on("click",async function(){const{roomName:a}=await A.get(`/chats/${t}`),f=await app.parseAndTranslate("modals/rename-room",{name:a}),C=u.dialog({title:"[[modules:chat.rename-room]]",message:f,onEscape:!0,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:function(){return A.put(`/chats/${t}`,{name:C.find("#roomName").val()}).then(()=>{C.modal("hide")}).catch(g.error),!1}}}})})},o.addSendHandlers=function(t,e,a){utils.isMobile()||e.off("keypress").on("keypress",function(f){if(f.which===13&&!f.shiftKey)return n.sendMessage(t,e),!1}),a.off("click").on("click",function(){return n.sendMessage(t,e),e.focus(),!1})},o.createAutoComplete=function(t,e,a={}){if(!e.length)return;const f={element:e,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top",className:`chat-autocomplete-dropdown-${t} dropdown-menu textcomplete-dropdown`,...a}};if($(window).trigger("chat:autocomplete:init",f),f.strategies.length){const C=c.setup(f);return t&&(o.activeAutocomplete[t]=C),C}},o.destroyAutoComplete=function(t){o.activeAutocomplete[t]&&(o.activeAutocomplete[t].destroy(),delete o.activeAutocomplete[t])},o.leave=function(t){const e=t.attr("data-roomid");A.del(`/chats/${e}/users/${app.user.uid}`,{}).then(()=>{parseInt(e,10)===parseInt(ajaxify.data.roomId,10)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats"):t.remove(),o.destroyAutoComplete(e);const a=x.getModal(e);a.length&&x.close(a)}).catch(g.error)},o.switchChat=function(t){t||(t=""),o.destroyAutoComplete(ajaxify.data.roomId),socket.emit("modules.chats.leave",ajaxify.data.roomId);const e="user/"+ajaxify.data.userslug+"/chats/"+t+window.location.search;if(!self.fetch)return ajaxify.go(e);const a=new URL(document.location).searchParams;a.set("switch",1);const f=`${config.relative_path}/api/user/${ajaxify.data.userslug}/chats/${t}?${a.toString()}`;fetch(f,{credentials:"include"}).then(async function(C){if(!C.ok)return console.warn("[search] Received "+C.status);const S=await C.json(),I=await app.parseAndTranslate("partials/chats/message-window",S),L=y.get("chat/main-wrapper");L.html(I),L.attr("data-roomid",t),k=$('[component="chat/nav-wrapper"]'),I.find(".timeago").timeago(),ajaxify.data={...ajaxify.data,...S,roomId:t},ajaxify.updateTitle(ajaxify.data.title),$("body").toggleClass("chat-loaded",!!t),L.find('[data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),o.setActive(t),o.addEventListeners(),d.fire("action:chat.loaded",$(".chats-full")),n.scrollToBottomAfterImageLoad(L.find('[component="chat/message/content"]')),history.pushState&&history.pushState({url:e},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+e)}).catch(function(C){console.warn("[search] "+C.message)})},o.addGlobalEventListeners=function(){$(window).on("mousemove keypress click",function(){j&&ajaxify.data.roomId&&(A.del(`/chats/${ajaxify.data.roomId}/state`,{}),j=!1)})},o.addSocketListeners=function(){socket.on("event:chats.receive",function(t){x.isFromBlockedUser(t.fromUid)||parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10)&&(t.self=parseInt(app.user.uid,10)===parseInt(t.fromUid,10)?1:0,j||(j=t.self===0),t.message.self=t.self,t.message.timestamp=Math.min(Date.now(),t.message.timestamp),t.message.timestampISO=utils.toISOString(t.message.timestamp),n.appendChatMessage($('[component="chat/message/content"]'),t.message))}),socket.on("event:chats.public.unread",function(t){x.isFromBlockedUser(t.fromUid)||x.isLookingAtRoom(t.roomId)||app.user.uid===parseInt(t.fromUid,10)||(o.markChatPageElUnread(t),o.increasePublicRoomUnreadCount(k.find("[data-roomid="+t.roomId+"]")))}),socket.on("event:user_status_change",function(t){app.updateUserStatus($('.chats-list [data-uid="'+t.uid+'"] [component="user/status"]'),t.status)}),n.addSocketListeners(),socket.on("event:chats.roomRename",function(t){const e=y.get("chat/recent/room",t.roomId);if(e.length){const f=e.find('[component="chat/room/title"]');ajaxify.data.roomName=t.newName,f.translateText(t.newName?t.newName:ajaxify.data.usernames)}const a=$(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"] [component="chat/header/title"]`);a.length&&a.html(t.newName?`<i class="fa ${ajaxify.data.icon} text-muted"></i> ${t.newName}`:ajaxify.data.chatWithMessage)}),socket.on("event:chats.mark",({roomId:t,state:e})=>{$(`[component="chat/recent"] [data-roomid="${t}"], [component="chat/list"] [data-roomid="${t}"], [component="chat/public"] [data-roomid="${t}"]`).each((f,C)=>{const S=$(C);x.markChatElUnread(S,e===1),e===0&&o.updatePublicRoomUnreadCount(S,0)})}),socket.on("event:chats.typing",async t=>{t.uid===app.user.uid||x.isFromBlockedUser(t.uid)||x.updateTypingUserList($(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"]`),t)})},o.markChatPageElUnread=function(t){if(!ajaxify.data.template.chats)return;const e=k.find("[data-roomid="+t.roomId+"]");x.markChatElUnread(e,!0)},o.increasePublicRoomUnreadCount=function(t){const e=t.find('[component="chat/public/room/unread/count"]'),a=(parseInt(e.attr("data-count"),10)||0)+1;o.updatePublicRoomUnreadCount(t,a)},o.updatePublicRoomUnreadCount=function(t,e){const a=t.find('[component="chat/public/room/unread/count"]'),f=e>50?"50+":e;a.toggleClass("hidden",e<=0).text(f).attr("data-count",e)},o.setActive=function(t){if(k.find("[data-roomid]").removeClass("active"),t){socket.emit("modules.chats.enter",t);const e=k.find(`[data-roomid="${t}"]`);e.addClass("active"),e.hasClass("unread")&&(A.del(`/chats/${t}/state`,{}),e.removeClass("unread")),utils.isMobile()||$('.expanded-chat [component="chat/input"]').focus(),n.updateTextAreaHeight($(`[component="chat/messages"][data-roomid="${t}"]`))}k.attr("data-loaded",t?"1":"0")},o}.apply(T,b),E!==void 0&&(w.exports=E)},80083:(w,T,m)=>{"use strict";var b,E;b=[m(52473),m(49897),m(29930),m(53309)],E=function(y,v,l,p){const h={};h.init=function(){y.get("chat/create").on("click",n)};async function n(){let s=[];app.user.isAdmin&&({groups:s}=await v.get("/admin/groups"),s.sort((d,u)=>u.system-d.system).map(d=>{const{name:u,displayName:g}=d;return{name:u,displayName:g}}));const i=await app.parseAndTranslate("modals/create-room",{user:app.user,groups:s}),r=bootbox.dialog({title:"[[modules:chat.create-room]]",message:i,onEscape:!0,buttons:{save:{label:"[[global:create]]",className:"btn-primary",callback:function(){const d=r.find('[component="chat/room/name"]').val(),u=r.find('[component="chat/room/users"] [component="chat/user"]').find("[data-uid]").map((A,D)=>$(D).attr("data-uid")).get(),g=r.find('[component="chat/room/type"]').val(),x=r.find('[component="chat/room/groups"]').val();return g==="private"&&!u.length?(l.error("[[error:no-users-selected]]"),!1):g==="public"&&!x.length?(l.error("[[error:no-groups-selected]]"),!1):app.user.uid?(v.post("/chats",{roomName:d,uids:u,type:g,groups:x}).then(({roomId:A})=>{ajaxify.go("chats/"+A),r.modal("hide")}).catch(l.error),!1):(l.error("[[error:not-logged-in]]"),!1)}}}}),c=r.find('[component="chat/room/users"]');p.init({onSelect:async function(d){const u=await app.parseAndTranslate("modals/create-room","selectedUsers",{selectedUsers:[d]});c.append(u)}}),c.on("click",'[component="chat/room/users/remove"]',function(){$(this).parents("[data-uid]").remove()}),r.find('[component="chat/room/type"]').on("change",function(){const d=$(this).val();r.find('[component="chat/room/public/options"]').toggleClass("hidden",d==="private")})}return h}.apply(T,b),E!==void 0&&(w.exports=E)},58836:(w,T,m)=>{"use strict";var b,E;b=[m(49897),m(29930),m(17459),m(34405),m(72513)],E=function(y,v,l,p,h){const n={};n.init=function(c,d){let u;d.on("click",async function(){let g=[];app.user.isAdmin&&({groups:g}=await y.get("/admin/groups"),g.sort((k,t)=>t.system-k.system).map(k=>{const{name:t,displayName:e}=k;return{name:t,displayName:e}}),Array.isArray(ajaxify.data.groups)&&g.forEach(k=>{k.selected=ajaxify.data.groups.includes(k.name)}));const x=await app.parseAndTranslate("modals/manage-room",{groups:g,user:app.user,room:ajaxify.data});u=bootbox.dialog({title:"[[modules:chat.manage-room]]",size:"large",message:x,onEscape:!0}),u.attr("component","chat/manage-modal"),r(c,u),s(c,u),i(c,u);const A=u.find('[component="chat/manage/user/list"]'),D=u.find('[component="chat/manage/user/list/search"]');h.addSearchHandler(c,D,async k=>{D.val()?A.html(await app.parseAndTranslate("partials/chats/manage-room-users",k)):r(c,u)}),h.addInfiniteScrollHandler(c,A,async(k,t)=>{k.append(await app.parseAndTranslate("partials/chats/manage-room-users",t))});const o=u.find('[component="chat/manage/user/add/search"]'),j=u.find(".text-danger");p.user(o,function(k,t){j.text(""),y.post(`/chats/${c}/users`,{uids:[t.item.user.uid]}).then(e=>{r(c,u,e),o.val("")}).catch(e=>{l.translate(e.message,function(a){j.text(a)})})}),u.find('[component="chat/manage/save"]').on("click",()=>{const k=u.find('[component="chat/room/notification/setting"]');y.put(`/chats/${c}`,{groups:u.find('[component="chat/room/groups"]').val(),notificationSetting:k.val()}).then(t=>{ajaxify.data.groups=t.groups,ajaxify.data.notificationSetting=t.notificationSetting;const e=t.notificationOptions[0];$('[component="chat/notification/setting"] [data-icon]').first().attr("data-icon",e.icon),$('[component="chat/notification/setting/sub-label"]').translateText(e.subLabel),e.selected&&$('[component="chat/notification/setting/icon"]').attr("class",`fa ${e.icon}`),u.modal("hide")}).catch(v.error)})})};function s(c,d){d.on("click",'[data-action="kick"]',function(){const u=parseInt(this.getAttribute("data-uid"),10);y.del(`/chats/${c}/users/${u}`,{}).then(g=>{r(c,d,g)}).catch(v.error)})}function i(c,d){d.on("click",'[data-action="toggleOwner"]',async function(){const u=parseInt(this.getAttribute("data-uid"),10),g=d.get(0).querySelector(`[component="chat/manage/user/list"] > [data-uid="${u}"] [component="chat/manage/user/owner/icon"]`),x=!g.classList.contains("hidden");await y[x?"del":"put"](`/chats/${c}/owners/${u}`),g.classList.toggle("hidden")})}async function r(c,d,u){const g=d.find('[component="chat/manage/user/list"]');if(!u)try{u=await y.get(`/chats/${c}/users`,{})}catch{g.find("li").text(await l.translate("[[error:invalid-data]]"))}g.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),g.html(await app.parseAndTranslate("partials/chats/manage-room-users",u)),g.find('[data-bs-toggle="tooltip"]').tooltip()}return n}.apply(T,b),E!==void 0&&(w.exports=E)},65161:(w,T,m)=>{"use strict";var b,E;b=[m(52473),m(29930),m(60419)],E=function(y,v,l){const p={};let h=0,n,s,i,r,c,d;p.init=function(D,o){h=D,s=o.find('[component="chat/message/search/results"]'),i=o.find('[component="chat/message/content"]'),r=o.find('[component="chat/room/search/clear"]'),d=o.find('[component="chat/room/search/container"]'),c=o.find('[component="chat/room/search/toggle"'),n=o.find('[component="chat/room/search"]'),n.on("keyup",utils.debounce(g,250)).on("focus",()=>{n.val()&&g()}),o.find('[component="chat/input"]').on("focus",()=>{s.addClass("hidden"),i.removeClass("hidden")}),r.on("click",u),c.on("click",()=>{d.removeClass("hidden"),c.addClass("hidden"),n.trigger("focus")}),n.on("blur",()=>{n.val()||u()})};function u(){n.val(""),x(),s.addClass("hidden"),r.addClass("hidden"),d.addClass("hidden"),i.removeClass("hidden"),c.removeClass("hidden")}async function g(){const D=n.val();!D||D.length<=2||(r.removeClass("hidden"),socket.emit("modules.chats.searchMessages",{content:D,roomId:h}).then(A).catch(v.error))}function x(){s.children("[data-mid]").remove()}async function A(D){if(x(),!D.length)return s.removeClass("hidden"),i.addClass("hidden"),s.find('[component="chat/message/search/no-results"]').removeClass("hidden");s.find('[component="chat/message/search/no-results"]').addClass("hidden");const o=await app.parseAndTranslate("partials/chats/messages",{messages:D,isAdminOrGlobalMod:app.user.isAdmin||app.user.isGlobalMod});s.append(o),l.onMessagesAddedToDom(s.find('[component="chat/message"]')),i.addClass("hidden"),s.removeClass("hidden")}return p}.apply(T,b),E!==void 0&&(w.exports=E)},93230:(w,T,m)=>{"use strict";var b,E;b=[m(49897),m(29930)],E=function(y,v){const l={};let p;l.init=function(i){p=i,$('[component="chat/pinned/messages/btn"]').on("click",async()=>{const r=p.find('[component="chat/messages/pinned/container"]');if(!r.hasClass("hidden"))return r.addClass("hidden");p.find('[component="chat/user/list"]').addClass("hidden"),await l.refreshList(),r.removeClass("hidden")}),h(p)};function h(i){const r=i.find('[component="chat/messages/pinned"]');r.on("scroll",utils.debounce(async()=>{const c=(r[0].scrollHeight-r.height())*.85;if(r.scrollTop()>c){const d=r.find("[data-index]").last().attr("data-index"),u=await s(parseInt(d,10)+1);if(u&&u.length){const g=await n(u);i.find('[component="chat/messages/pinned"]').append(g)}}},200))}l.refreshList=async function(){const i=await s(0);if(!i.length){p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden"),p.find('[component="chat/messages/pinned"]').html("");return}p.find('[component="chat/messages/pinned/empty"]').addClass("hidden");const r=await n(i);p.find('[component="chat/messages/pinned"]').html(r),r.find(".timeago").timeago()};async function n(i){return await app.parseAndTranslate("partials/chats/pinned-messages-list","messages",{isOwner:ajaxify.data.isOwner,isAdminOrGlobalMod:ajaxify.data.isAdminOrGlobalMod,messages:i})}async function s(i){const{messages:r}=await y.get(`/chats/${ajaxify.data.roomId}/messages/pinned`,{start:i});return r}return l.pin=function(i,r){y.put(`/chats/${r}/messages/${i}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${i}"]`).toggleClass("pinned",!0),l.refreshList()}).catch(v.error)},l.unpin=function(i,r){y.del(`/chats/${r}/messages/${i}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${i}"]`).toggleClass("pinned",!1),p.find(`[component="chat/messages/pinned"] [data-mid="${i}"]`).remove(),p.find('[component="chat/messages/pinned"] [data-mid]').length||p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden")}).catch(v.error)},l}.apply(T,b),E!==void 0&&(w.exports=E)},72513:(w,T,m)=>{"use strict";var b,E;b=[m(49897)],E=function(y){const v={};let l=0;v.init=function(s,i){const r=i.find('[component="chat/user/list"]');if(!r.length)return;const c=i.find('[component="chat/messages/pinned/container"]');i.find('[component="chat/user/list/btn"]').on("click",()=>{r.toggleClass("hidden"),r.hasClass("hidden")?h():(c.addClass("hidden"),p(s,r))}),$(window).off("action:ajaxify.start",h).one("action:ajaxify.start",h),v.addInfiniteScrollHandler(s,r,async(d,u)=>{d.append(await app.parseAndTranslate("partials/chats/user-list","users",u))})};function p(s,i){l&&clearInterval(l),l=setInterval(()=>{n(s,i)},5e3)}function h(){l&&(clearInterval(l),l=0)}async function n(s,i){if(ajaxify.data.template.chats&&app.isFocused&&i.scrollTop()===0&&!i.hasClass("hidden")){const r=await y.get(`/chats/${s}/users`,{start:0});i.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),i.html(await app.parseAndTranslate("partials/chats/user-list","users",r)),i.find('[data-bs-toggle="tooltip"]').tooltip()}}return v.addInfiniteScrollHandler=function(s,i,r){i.on("scroll",utils.debounce(async()=>{const c=(i[0].scrollHeight-i.height())*.85;if(i.scrollTop()>c){const d=i.find("[data-index]").last().attr("data-index"),u=await y.get(`/chats/${s}/users`,{start:parseInt(d,10)+1});u&&u.users.length&&r(i,u)}},200))},v.addSearchHandler=function(s,i,r){i.on("keyup",utils.debounce(async()=>{const c=i.val(),d=await y.get(`/search/chats/${s}/users`,{query:c});r(d)},200))},v}.apply(T,b),E!==void 0&&(w.exports=E)},53309:(w,T,m)=>{"use strict";var b,E;b=[m(52473),m(49897),m(29930)],E=function(y,v,l){const p={};let h=[];p.init=function(c){c=c||{},h.length=0,y.get("chat/search").on("keyup",utils.debounce(s,250));const d=$('[component="chat/search/list"]');d.on("click","[data-uid]",function(){c.onSelect&&c.onSelect(h.find(u=>parseInt(u.uid,10)===parseInt($(this).attr("data-uid"),10))),n(d)})};function n(c){y.get("chat/search").val(""),i(c),c.find('[component="chat/search/no-users"]').addClass("hidden"),c.find('[component="chat/search/start-typing"]').removeClass("hidden")}function s(){const c=$('[component="chat/search/list"]'),d=y.get("chat/search").val();if(!d)return n(c);c.find('[component="chat/search/start-typing"]').addClass("hidden"),v.get("/api/users",{query:d,searchBy:"username",paginate:!1}).then(r).catch(l.error)}function i(c){h.length=0,c.find("[data-uid]").remove()}async function r(c){const d=$('[component="chat/search/list"]');if(i(d),c.users=c.users.filter(function(g){return parseInt(g.uid,10)!==parseInt(app.user.uid,10)}),h=c.users,!c.users.length)return d.find('[component="chat/search/no-users"]').removeClass("hidden");d.find('[component="chat/search/no-users"]').addClass("hidden");const u=await app.parseAndTranslate("modals/create-room","searchUsers",{searchUsers:c.users});d.append(u),d.parent().toggleClass("show",!0)}return p}.apply(T,b),E!==void 0&&(w.exports=E)},34405:(w,T,m)=>{"use strict";var b,E;b=[m(49897),m(29930)],E=function(y,v){const l={},p={delay:200,appendTo:null};l.init=n=>{const s={...p,...n},{input:i,onSelect:r}=s;app.loadJQueryUI(function(){i.autocomplete({...s,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(c,d){h(i,r,c,d)}})})},l.user=function(n,s,i){typeof s=="function"&&(i=s,s={}),s=s||{},l.init({input:n,onSelect:i,source:(r,c)=>{s.query=r.term,y.get("/api/users",s,function(d,u){if(d)return v.error(d);if(u&&u.users){const g=u.users.map(function(x){const A=$("<div></div>").html(x.username).text();return x&&{label:A,value:A,user:{uid:x.uid,name:x.username,slug:x.userslug,username:x.username,userslug:x.userslug,picture:x.picture,banned:x.banned,"icon:text":x["icon:text"],"icon:bgColor":x["icon:bgColor"]}}});c(g)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},l.group=function(n,s){l.init({input:n,onSelect:s,source:(i,r)=>{socket.emit("groups.search",{query:i.term},function(c,d){if(c)return v.error(c);if(d&&d.length){const u=d.map(function(g){return g&&{label:g.name,value:g.name,group:g}});r(u)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},l.tag=function(n,s){l.init({input:n,onSelect:s,delay:100,source:(i,r)=>{socket.emit("topics.autocompleteTags",{query:i.term,cid:ajaxify.data.cid||0},function(c,d){if(c)return v.error(c);d&&r(d),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function h(n,s,i,r){s=s||function(){};const c=jQuery.Event("keypress");c.which=13,c.keyCode=13,setTimeout(function(){n.trigger(c)},100),s(i,r)}return l}.apply(T,b),E!==void 0&&(w.exports=E)},88518:(w,T,m)=>{w.exports=m(54516)},89596:(w,T,m)=>{w.exports=m(62590)},43103:(w,T,m)=>{"use strict";var b,E;b=[m(29930)],E=function(y){const v={};return v.init=function(l){const p=l.uploadFormEl;if(p.length&&(p.attr("action",config.relative_path+l.route),l.dragDropAreaEl&&v.handleDragDrop({container:l.dragDropAreaEl,callback:function(h){v.ajaxSubmit({uploadForm:p,upload:h,callback:l.callback})}}),l.pasteEl&&v.handlePaste({container:l.pasteEl,callback:function(h){v.ajaxSubmit({uploadForm:p,upload:h,callback:l.callback})}}),l.uploadBtnEl)){const h=p.find('input[name="files[]"]');l.uploadBtnEl.on("click",function(){h.trigger("click")}),h.on("change",function(n){const s=(n.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);s&&v.ajaxSubmit({uploadForm:p,upload:{files:s,fileNames:Array.from(s).map(i=>i.name)},callback:l.callback})})}},v.handleDragDrop=function(l){let p=!1;const h=l.container,n=l.container.find(".imagedrop");h.on("dragenter",function(){p||(n.css("top","0px"),n.css("height",h.height()+"px"),n.css("line-height",h.height()+"px"),n.show(),n.on("dragleave",function(){n.hide(),n.off("dragleave")}))}),n.on("drop",function(r){r.preventDefault();const c=r.originalEvent.dataTransfer.files;if(c.length){let u;if(window.FormData){u=new FormData;for(var d=0;d<c.length;++d)u.append("files[]",c[d],c[d].name)}l.callback({files:c,formData:u})}return n.hide(),!1});function s(i){return i.preventDefault(),!1}$(document).off("dragstart").on("dragstart",function(){p=!0}).off("dragend").on("dragend, mouseup",function(){p=!1}),n.on("dragover",s),n.on("dragenter",s)},v.handlePaste=function(l){l.container.on("paste",function(h){const n=(h.clipboardData||h.originalEvent.clipboardData||{}).items,s=[],i=[];let r=null;window.FormData&&(r=new FormData),[].forEach.call(n,function(c){const d=c.getAsFile();if(d){const u=utils.generateUUID()+"-"+d.name;r&&r.append("files[]",d,u),s.push(d),i.push(u)}}),s.length&&l.callback({files:s,fileNames:i,formData:r})})},v.ajaxSubmit=function(l){const p=[...l.upload.files];for(let n=0;n<p.length;++n){const s=p[n].type.match(/image./);if(s&&!app.user.privileges["upload:post:image"]||!s&&!app.user.privileges["upload:post:file"])return y.error("[[error:no-privileges]]");if(!app.user.isAdmin&&p[n].size>parseInt(config.maximumFileSize,10)*1024)return l.uploadForm[0].reset(),y.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const h=Date.now();l.uploadForm.off("submit").on("submit",function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:l.upload.formData,error:function(n){let s=n.responseJSON&&(n.responseJSON.error||n.responseJSON.status&&n.responseJSON.status.message)||"[[error:parse-error]]";n&&n.status===413&&(s=n.statusText||"Request Entity Too Large"),y.error(s),y.remove(h)},uploadProgress:function(n,s,i,r){y.alert({alert_id:h,message:"[[modules:composer.uploading, "+r+"%]]"})},success:function(n){const s=n.response.images;if(s&&s.length)for(var i=0;i<s.length;++i)s[i].filename=p[i].name,s[i].isImage=/image./.test(p[i].type);l.callback(s)},complete:function(){l.uploadForm[0].reset(),setTimeout(y.remove,100,h)}}),!1}),l.uploadForm.submit()},v}.apply(T,b),E!==void 0&&(w.exports=E)},62590:(w,T,m)=>{"use strict";var b,E;b=[m(91749)],E=function(y){var v={};return v.render=function(l,p){if(p=p||function(){},!l.find(".preview-container").is(":visible"))return p();var h=l.find("textarea");socket.emit("plugins.composer.renderPreview",h.val(),function(n,s){n||(s=$("<div>"+s+"</div>"),s.find("img:not(.not-responsive)").addClass("img-fluid"),l.find(".preview").html(s),y.fire("action:composer.preview",{postContainer:l,preview:s}),p())})},v.matchScroll=function(l){if(l.find(".preview-container").is(":visible")){var p=l.find("textarea"),h=l.find(".preview");if(p.length&&h.length){var n=p[0].scrollHeight-p.height();if(n===0)return;var s=p.scrollTop()/n;h.scrollTop(Math.max(h[0].scrollHeight-h.height(),0)*s)}}},v.handleToggler=function(l){const p=l.get(0);v.env=utils.findBootstrapEnvironment();const h=["xs","sm"].includes(v.env),n=p.querySelector('.formatting-bar [data-action="preview"]'),s=n.querySelector(".show-text"),i=n.querySelector(".hide-text"),r=localStorage.getItem("composer:previewToggled"),c=config["composer-default"].hidePreviewOnOpen==="on";let d=!h&&(r===null&&!c||r==="true");const u=p.querySelector(".preview-container"),g=p.querySelector(".write-container");if(!n)return;function x(A){h?(u.classList.toggle("hide",!1),g.classList.toggle("maximized",!1),u.classList.toggle("d-none",!A),u.classList.toggle("d-flex",A),u.classList.toggle("w-100",A),g.classList.toggle("d-flex",!A),g.classList.toggle("d-none",A),g.classList.toggle("w-100",!A)):(u.classList.toggle("hide",!A),g.classList.toggle("w-50",A),g.classList.toggle("w-100",!A),localStorage.setItem("composer:previewToggled",A)),s.classList.toggle("hide",A),i.classList.toggle("hide",!A),A&&v.render(l),v.matchScroll(l)}v.toggle=x,n.addEventListener("click",A=>{A.button===0&&(d=!d,x(d))}),x(d)},v}.apply(T,b),E!==void 0&&(w.exports=E)}}]);
