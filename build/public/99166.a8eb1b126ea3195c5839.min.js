"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[99166],{49641:(K,k,s)=>{var D,C;D=[s(14063),s(17459),s(31494),s(449),s(74566),s(52543),s(13342),s(89596),s(99594),s(88518),s(72573),s(92762),s(41088),s(36159),s(49897),s(40027),s(29930),s(91749),s(10870),s(69749),s(51916)],C=function(A,E,S,T,v,f,M,c,r,n,d,m,x,y,P,L,a,l,p,W,F){var i={active:void 0,posts:{},bsEnvironment:void 0,formatting:void 0};$(window).off("resize",G).on("resize",G),G(),$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark"),localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")}),$(window).on("popstate",function(){var e=utils.findBootstrapEnvironment();if(i.active&&(e==="xs"||e==="sm")){if(!i.posts[i.active].modified){i.discard(i.active),i.discardConfirm&&i.discardConfirm.length&&(i.discardConfirm.modal("hide"),delete i.discardConfirm);return}E.translate("[[modules:composer.discard]]",function(t){i.discardConfirm=L.confirm(t,function(o){o?i.discard(i.active):i.posts[i.active].modified=!0}),i.posts[i.active].modified=!1})}});function j(){var e=i.bsEnvironment;(ajaxify.data.template.compose===!0||e==="xs"||e==="sm")&&history.back()}function G(){var e=utils.findBootstrapEnvironment(),t=e==="xs"||e==="sm";c.toggle&&(c.env!==e&&t&&(c.env=e,c.toggle(!1)),c.env=e),i.active!==void 0&&(r.reposition($('.composer[data-uuid="'+i.active+'"]')),!t&&window.location.pathname.startsWith(config.relative_path+"/compose")?history.back():t&&!window.location.pathname.startsWith(config.relative_path+"/compose")&&ne()),i.bsEnvironment=e}function g(e){var t,o;e.hasOwnProperty("cid")?t="cid":e.hasOwnProperty("tid")?t="tid":e.hasOwnProperty("pid")&&(t="pid"),o=e[t];for(var h in i.posts)if(i.posts[h].hasOwnProperty(t)&&o===i.posts[h][t])return h;return!1}function u(e){if(e){var t=utils.generateUUID(),o=g(e);if(o)return A.updateActive(o),i.load(o);var h="[[topic:composer.new-topic]]";e.action==="posts.reply"?h="[[topic:composer.replying-to]]":e.action==="posts.edit"&&(h="[[topic:composer.editing-in]]"),E.translate(h,function(I){A.push("composer",t,{title:I.replace("%1",'"'+e.title+'"')})}),i.posts[t]=e,i.load(t)}}async function b(e,t){$('.composer[data-uuid="'+e+'"]').find(".composer-submit").removeAttr("disabled");const{showAlert:o}=await l.fire("filter:composer.error",{post_uuid:e,message:t,showAlert:!0});o&&a.alert({type:"danger",timeout:1e4,title:"",message:t,alert_id:"post_error"})}i.findByTid=function(e){for(var t in i.posts)if(i.posts.hasOwnProperty(t)&&i.posts[t].hasOwnProperty("tid")&&parseInt(i.posts[t].tid,10)===parseInt(e,10))return t;return null},i.addButton=function(e,t,o){T.addButton(e,t,o)},i.newTopic=async e=>{let t={save_id:e.save_id,action:"topics.post",cid:e.cid,handle:e.handle,title:e.title||"",body:e.body||"",tags:e.tags||[],modified:!!(e.title&&e.title.length||e.body&&e.body.length),isMain:!0};({pushData:t}=await l.fire("filter:composer.topic.push",{data:e,pushData:t})),u(t)},i.addQuote=function(e){e.uuid=e.uuid||i.active;var t=(e.title||"").replace(/([\\`*_{}[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");e.body&&(e.body="> "+e.body.replace(/\n/g,`
> `)+`

`);var o="["+t+"]("+config.relative_path+"/post/"+(e.selectedPid||e.toPid)+")";if(e.uuid===void 0){e.title&&(e.selectedPid||e.toPid)?i.newReply({tid:e.tid,toPid:e.toPid,title:e.title,body:"[[modules:composer.user-said-in, "+e.username+", "+o+`]]
`+e.body}):i.newReply({tid:e.tid,toPid:e.toPid,title:e.title,body:"[[modules:composer.user-said, "+e.username+`]]
`+e.body});return}else e.uuid!==i.active&&i.load(e.uuid);var h=$('.composer[data-uuid="'+e.uuid+'"]'),I=h.find("textarea"),w=I.val();e.title&&(e.selectedPid||e.toPid)?E.translate("[[modules:composer.user-said-in, "+e.username+", "+o+`]]
`,config.defaultLang,N):E.translate("[[modules:composer.user-said, "+e.username+`]]
`,config.defaultLang,N);function N(X){i.posts[e.uuid].body=(w.length?w+`

`:"")+X+e.body,I.val(i.posts[e.uuid].body),O(h),c.render(h)}},i.newReply=function(e){E.translate(e.body,config.defaultLang,function(t){u({save_id:e.save_id,action:"posts.reply",tid:e.tid,toPid:e.toPid,title:e.title,body:t,modified:!!(t&&t.length),isMain:!1})})},i.editPost=function(e){socket.emit("plugins.composer.push",e.pid,function(t,o){if(t)return a.error(t);o.save_id=e.save_id,o.action="posts.edit",o.pid=e.pid,o.modified=!1,e.body&&(o.body=e.body,o.modified=!0),e.title&&(o.title=e.title,o.modified=!0),u(o)})},i.load=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.length?(B(e),r.reposition(t),O(t),q()):i.formatting?ie(e):socket.emit("plugins.composer.getFormattingOptions",function(o,h){if(o)return a.error(o);i.formatting=h,ie(e)})},i.enhance=function(e,t,o){!t&&!o&&(t=utils.generateUUID(),i.posts[t]=ajaxify.data,o=ajaxify.data,e.attr("data-uuid",t)),M.init(e,i.posts[t]),d.init(e,i.posts),T.addHandler(e),T.addComposerButtons(),c.handleToggler(e),m.showAlert(e,o),S.initialize(t),f.init(e,i.posts[t]),n.init(e,t),e.on("change","input, textarea",function(){i.posts[t].modified=!0}),e.on("click",".composer-submit",function(w){w.preventDefault(),w.stopPropagation(),$(this).attr("disabled",!0),R(t)}),s.e(6411).then(function(){var w=[s(6411)];(function(N){N(e.get(0)).bind("mod+enter",function(){e.find(".composer-submit").attr("disabled",!0),R(t)})}).apply(null,w)}).catch(s.oe),e.find(".composer-discard").on("click",function(w){if(w.preventDefault(),!i.posts[t].modified)return i.discard(t),j();T.exitFullscreen();var N=$(this).prop("disabled",!0);E.translate("[[modules:composer.discard]]",function(X){L.confirm(X,function(_){_&&(i.discard(t),j()),N.prop("disabled",!1)})})}),e.find(".composer-minimize, .minimize .trigger").on("click",function(w){w.preventDefault(),w.stopPropagation(),i.minimize(t)});const h=e.find("textarea");h.on("input propertychange",utils.debounce(function(){c.render(e)},250)),h.on("scroll",function(){c.matchScroll(e)}),v.init(e,o);const I=v.get(o.save_id);c.render(e,function(){c.matchScroll(e)}),re(e),Z(e),O(e),o.action==="posts.edit"&&i.updateThumbCount(t,e),F.isEnabled||$('[data-format="zen"]').parent().addClass("hidden"),l.fire("action:composer.enhanced",{postContainer:e,postData:o,draft:I})};async function V(e){return ajaxify.data.template.category&&parseInt(e.cid,10)===parseInt(ajaxify.data.cid,10)?ajaxify.data:parseInt(e.cid,10)?await P.get(`/api/category/${e.cid}`,{}):null}async function ie(e){var t=i.posts[e],o=t?t.hasOwnProperty("cid"):!1,h=t?!!t.isMain:!1,I=t?!!t.pid:!1,w=t?parseInt(t.uid,10)===0:!1;const N=t.timestamp>Date.now();var X=t.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");t.category=await V(t);const _=t.category?t.category.privileges:ajaxify.data.privileges;var z={topicTitle:X,titleLength:X.length,body:E.escape(utils.escapeHTML(t.body)),mobile:i.bsEnvironment==="xs"||i.bsEnvironment==="sm",resizable:!0,thumb:t.thumb,isTopicOrMain:o||h,maximumTitleLength:config.maximumTitleLength,maximumPostLength:config.maximumPostLength,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,"composer:showHelpTab":config["composer:showHelpTab"],isTopic:o,isEditing:I,canSchedule:!!(h&&_&&(_["topics:schedule"]&&!I||N&&_.view_scheduled)),showHandleInput:config.allowGuestHandles&&(app.user.uid===0||I&&w&&app.user.isAdmin),handle:t?t.handle||"":void 0,formatting:i.formatting,tagWhitelist:t.category?t.category.tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges,selectedCategory:t.category,submitOptions:[]};z.mobile&&(ne(),app.toggleNavbar(!1)),t.mobile=i.bsEnvironment==="xs"||i.bsEnvironment==="sm",{postData:t,createData:z}=await l.fire("filter:composer.create",{postData:t,createData:z}),app.parseAndTranslate("composer",z,function(U){if(!$('.composer.composer[data-uuid="'+e+'"]').length){U=$(U),U.find(".title").each(function(){$(this).text(E.unescape($(this).text()))}),U.attr("data-uuid",e),$(document.body).append(U);var H=$(U[0]);if(r.reposition(H),i.enhance(H,e,t),B(e),H.on("click",function(){A.isActive(e)||A.updateActive(e)}),r.handleResize(H),i.bsEnvironment==="xs"||i.bsEnvironment==="sm"){var Y=H.find(".composer-submit"),Q=H.find(".mobile-navbar .composer-submit"),oe=H.find(".write"),te=oe.attr("tabindex");Y.removeAttr("tabindex"),Q.attr("tabindex",parseInt(te,10)+1)}$(window).trigger("action:composer.loaded",{postContainer:H,post_uuid:e,composerData:i.posts[e],formatting:i.formatting}),x.apply(H.find(".write")),O(H),q()}})}function ne(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1)+window.location.search;t.startsWith(config.relative_path.slice(1))&&(t=t.slice(config.relative_path.length)),window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t),window.history.pushState({url:e},e,`${config.relative_path}/${t}`)}function re(e){const t=e.find('[data-action="help"]');t.on("click",async function(){const o=await socket.emit("plugins.composer.renderHelp");o&&o.length>0&&L.dialog({size:"large",message:o,onEscape:!0,backdrop:!0,onHidden:function(){t.focus()}})})}function Z(e){var t=e.attr("data-uuid"),o=i.posts[t]&&i.posts[t].action==="posts.edit",h=utils.findBootstrapEnvironment(),I=h==="xs"||h==="sm";o||I||W.enableQuickSearch({searchElements:{inputEl:e.find("input.title"),resultEl:e.find(".quick-search-container")},searchOptions:{composer:1},hideOnNoMatches:!0,hideDuringSearch:!0})}function B(e){i.active&&i.active!==e&&i.minimize(i.active),i.active=e;const t=$('.composer[data-uuid="'+e+'"]');t.css("visibility","visible"),$(window).trigger("action:composer.activate",{post_uuid:e,postContainer:t})}function O(e){setTimeout(function(){var t=e.find("input.title");t.length?t.focus():e.find("textarea").focus().putCursorAtEnd()},20)}async function R(e){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]'),h=o.find(".handle"),I=o.find(".title"),w=o.find("textarea"),N=o.find("input#topic-thumb-url"),X=t.hasOwnProperty("template")&&t.template.compose===!0;const _=o.find(".composer-submit");I.val(I.val().trim()),w.val(utils.rtrim(w.val())),N.length&&N.val(N.val().trim());var z=t.action,U=(t.hasOwnProperty("cid")||parseInt(t.pid,10))&&o.find("input.title").length,H=!U||U&&parseInt(t.cid,10),Y={post_uuid:e,postData:t,postContainer:o,titleEl:I,titleLen:I.val().length,bodyEl:w,bodyLen:w.val().length};if(await l.fire("filter:composer.check",Y),$(window).trigger("action:composer.check",Y),Y.error)return b(e,Y.error);if(S.inProgress[e]&&S.inProgress[e].length)return b(e,"[[error:still-uploading]]");if(U&&Y.titleLen<parseInt(config.minimumTitleLength,10))return b(e,"[[error:title-too-short, "+config.minimumTitleLength+"]]");if(U&&Y.titleLen>parseInt(config.maximumTitleLength,10))return b(e,"[[error:title-too-long, "+config.maximumTitleLength+"]]");if(z==="topics.post"&&!H)return b(e,"[[error:category-not-selected]]");if(Y.bodyLen<parseInt(config.minimumPostLength,10))return b(e,"[[error:content-too-short, "+config.minimumPostLength+"]]");if(Y.bodyLen>parseInt(config.maximumPostLength,10))return b(e,"[[error:content-too-long, "+config.maximumPostLength+"]]");if(U&&!f.isEnoughTags(e))return b(e,"[[error:not-enough-tags, "+f.minTagCount()+"]]");if(d.isActive()&&d.getTimestamp()<=Date.now())return b(e,"[[error:scheduling-to-past]]");let Q={uuid:e},oe="post",te="";z==="topics.post"?(te="/topics",Q={...Q,handle:h?h.val():void 0,title:I.val(),content:w.val(),thumb:N.val()||"",cid:M.getSelectedCid(),tags:f.getTags(e),timestamp:d.getTimestamp()}):z==="posts.reply"?(te=`/topics/${t.tid}`,Q={...Q,tid:t.tid,handle:h?h.val():void 0,content:w.val(),toPid:t.toPid}):z==="posts.edit"&&(oe="put",te=`/posts/${t.pid}`,Q={...Q,pid:t.pid,handle:h?h.val():void 0,content:w.val(),title:I.val(),thumb:N.val()||"",tags:f.getTags(e),timestamp:d.getTimestamp()});var ae={composerEl:o,action:z,composerData:Q,postData:t,redirect:!0};await l.fire("filter:composer.submit",ae),l.fire("action:composer.submit",Object.freeze(ae));var ce=$('#taskbar .composer[data-uuid="'+e+'"] i'),se=o.find(".write");ce.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin"),i.minimize(e),se.prop("readonly",!0),P[oe](te,Q).then(J=>{_.removeAttr("disabled"),t.submitted=!0,i.discard(e),v.removeDraft(t.save_id),J.queued?a.alert({type:"success",title:"[[global:alert.success]]",message:J.message,timeout:1e4,clickfn:function(){ajaxify.go(`/post-queue/${J.id}`)}}):z==="topics.post"?ae.redirect&&ajaxify.go("topic/"+J.slug,void 0,X||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"):z==="posts.reply"?X||i.bsEnvironment==="xs"||i.bsEnvironment==="sm"?window.history.back():ae.redirect&&(ajaxify.data.template.name!=="topic"||ajaxify.data.template.topic&&parseInt(t.tid,10)!==parseInt(ajaxify.data.tid,10))&&ajaxify.go("post/"+J.pid):j(),l.fire("action:composer."+z,{composerData:Q,data:J})}).catch(J=>{if(i.load(e),se.prop("readonly",!1),J.message==="[[error:email-not-confirmed]]")return p.showEmailConfirmWarning(J.message);b(e,J.message)})}function q(){$("html").addClass("composing")}function ee(){$("#content").css({paddingBottom:0}),$("html").removeClass("composing"),app.toggleNavbar(!0),T.exitFullscreen()}return i.discard=function(e){if(i.posts[e]){var t=i.posts[e],o=$('.composer[data-uuid="'+e+'"]');o.remove(),v.removeDraft(t.save_id),y.deleteAll(e),A.discard("composer",e),$('[data-action="post"]').removeAttr("disabled"),l.fire("action:composer.discard",{post_uuid:e,postData:t}),delete i.posts[e],i.active=void 0}d.reset(),ee()},i.close=i.discard,i.minimize=function(e){var t=$('.composer[data-uuid="'+e+'"]');t.css("visibility","hidden"),i.active=void 0,A.minimize("composer",e),$(window).trigger("action:composer.minimize",{post_uuid:e}),ee()},i.minimizeActive=function(){i.active&&i.miminize(i.active)},i.updateThumbCount=function(e,t){const o=i.posts[e];if(o.action==="topics.post"||o.action==="posts.edit"&&o.isMain){const h=[y.get(e)];o.pid&&h.push(y.getByPid(o.pid)),Promise.all(h).then(I=>{I=I.reduce((w,N)=>(w=w.concat(N),w)),I.length&&t.find('[data-format="thumbs"]').find(".badge").text(I.length).toggleClass("hidden",!I.length)})}},i}.apply(k,D),C!==void 0&&(K.exports=C)},41644:(K,k,s)=>{var D,C;D=[s(65348),s(14063),s(49897)],C=function(A,E,S){var T={},v;T.init=function(r,n){var d=r.find(".category-list-container");d.length&&(r.on("action:composer.resize",function(){f(r)}),T.updateTaskbar(r,n),v=A.init(d.find('[component="category-selector"]'),{privilege:"topics:create",states:["watching","tracking","notwatching","ignoring"],onSelect:function(m){n.hasOwnProperty("cid")&&c(r,n,m)}}),v&&(n.cid&&n.category?v.selectedCategory={cid:n.cid,name:n.category.name}:ajaxify.data.template.compose&&ajaxify.data.selectedCategory&&(v.selectedCategory={cid:ajaxify.data.cid,name:ajaxify.data.selectedCategory}),r.find(".category-name").translateText(v.selectedCategory?v.selectedCategory.name:"[[modules:composer.select-category]]").on("click",function(){A.modal({privilege:"topics:create",states:["watching","tracking","notwatching","ignoring"],openOnLoad:!0,showLinks:!1,onSubmit:function(m){r.find(".category-name").text(m.name),v.selectCategory(m.cid),n.hasOwnProperty("cid")&&c(r,n,m)}})}),f(r)))};function f(r){r.find('.category-list-container [component="category-selector"]').toggleClass("dropup",r.outerHeight()<$(window).height()/2)}T.getSelectedCid=function(){var r;return v&&(r=v.getSelectedCategory()),r?r.cid:0},T.updateTaskbar=function(r,n){parseInt(n.cid,10)&&S.get(`/categories/${n.cid}`,{}).then(function(d){M(r,d)})};function M(r,n){if(n){var d=r.attr("data-uuid");E.update("composer",d,{image:n.backgroundImage,color:n.color,"background-color":n.bgColor,icon:n.icon&&n.icon.slice(3)})}}async function c(r,n,d){n.cid=d.cid;const m=await window.fetch(`${config.relative_path}/api/category/${d.cid}`).then(x=>x.json());n.category=m,M(r,m),s.e(56382).then(function(){var x=[s(72573),s(52543),s(92762)];(function(y,P,L){y.onChangeCategory(m),P.onChangeCategory(r,n,d.cid,m),L.onChangeCategory(r,n),$(window).trigger("action:composer.changeCategory",{postContainer:r,postData:n,selectedCategory:d,categoryData:m})}).apply(null,x)}).catch(s.oe)}return T}.apply(k,D),C!==void 0&&(K.exports=C)},94252:(K,k)=>{var s,D;s=[],D=function(){const C={};return C.showAlert=async function(A,E){const S=A.find('[component="composer/post-queue/alert"]');if(!config.postQueue||app.user.isAdmin||app.user.isGlobalMod||app.user.isMod){S.remove();return}const T=await socket.emit("plugins.composer.shouldQueue",{postData:E});S.toggleClass("show",T),S.toggleClass("pe-none",!T)},C.onChangeCategory=async function(A,E){config.postQueue&&C.showAlert(A,E)},C}.apply(k,s),D!==void 0&&(K.exports=D)},59367:(K,k,s)=>{var D,C;D=[s(81335),s(40027),s(29930),s(17459)],C=function(A,E,S,T){const v={},f={timestamp:0,open:!1,edit:!1,posts:{}};let M=[],c,r,n,d;const m={el:null,defaultText:"",activeText:""},x={el:null,icon:null,defaultText:"",activeText:""};let y,P;$(window).on("action:composer.activate",p),v.init=function(g,u){f.timestamp=0,f.posts=u,T.translateKeys(["[[topic:composer.post-later]]","[[modules:composer.change-schedule-date]]"]).then(b=>{m.defaultText=b[0],m.activeText=b[1]}),M=g[0].querySelectorAll(".display-scheduler"),c=g[0].querySelectorAll(".display-scheduler i"),m.el=g[0].querySelector(".dropdown-item.display-scheduler"),r=g[0].querySelector(".dropdown-item.cancel-scheduling"),n=g.find('[component="composer/submit/container"]'),d=g.find('[component="composer/submit/options/container"]'),x.el=g[0].querySelector(".composer-submit:not(.btn-sm)"),x.icon=x.el.querySelector("i"),x.defaultText=x.el.lastChild.textContent,x.activeText=x.el.getAttribute("data-text-variant"),r.addEventListener("click",i),M.forEach(b=>b.addEventListener("click",L))},v.getTimestamp=function(){return!v.isActive()||isNaN(f.timestamp)?0:f.timestamp},v.isActive=function(){return f.timestamp>0},v.isOpen=function(){return f.open},v.reset=function(){f.timestamp=0},v.onChangeCategory=function(g){G(g.privileges["topics:schedule"]),j(!1);const u=g.privileges["topics:schedule"]||d.attr("data-submit-options")>0;n.find(".composer-submit").toggleClass("rounded-1",!u),d.toggleClass("hidden",!u),v.reset()};async function L(){const g=await A.render("modals/topic-scheduler");E.dialog({message:g,title:"[[modules:composer.schedule-for]]",className:"topic-scheduler",onShown:a,onHidden:l,onEscape:!0,buttons:{cancel:{label:f.timestamp?"[[modules:composer.cancel-scheduling]]":"[[modules:bootbox.cancel]]",className:(f.timestamp?"btn-warning":"btn-outline-secondary")+(f.edit?" hidden":""),callback:i},set:{label:"[[modules:composer.set-schedule-date]]",className:"btn-primary",callback:F}}})}function a(g){f.open=!0;const u=g.target.querySelector(".datetime-picker");y=u.querySelector('input[type="date"]'),P=u.querySelector('input[type="time"]'),W()}function l(){f.open=!1}function p(g,{post_uuid:u}){f.edit=!1;const b=f.posts[u];b&&b.isMain&&b.timestamp>Date.now()&&(f.timestamp=b.timestamp,f.edit=!0,j())}function W(){const g=new Date,u=new Date(g.getTime()-g.getTimezoneOffset()*6e4).toJSON();if(y.setAttribute("min",u.slice(0,10)),P.setAttribute("min",u.slice(11,-8)),v.isActive()){const b=new Date(f.timestamp-g.getTimezoneOffset()*6e4).toJSON();y.value=b.slice(0,10),P.value=b.slice(11,-8)}}function F(){const g=y.value&&P.value,u=new Date(`${y.value} ${P.value}`).getTime();if(!g||isNaN(u)||u<Date.now()){f.timestamp=0;const b=u<Date.now()?"[[error:scheduling-to-past]]":"[[error:invalid-schedule-date]]";return S.alert({type:"danger",timeout:3e3,title:"",alert_id:"post_error",message:b}),!1}f.timestamp||j(!0),f.timestamp=u}function i(){f.timestamp&&(j(!1),f.timestamp=0)}function j(g=!0){c.forEach(u=>u.classList.toggle("active",g)),x.icon&&(x.icon.classList.toggle("fa-check",!g),x.icon.classList.toggle("fa-clock-o",g)),m.el&&(m.el.textContent=g?m.activeText:m.defaultText,r.classList.toggle("hidden",!g)),x.el.lastChild.textContent=g?x.activeText:x.defaultText}function G(g){M.forEach(u=>u.classList.toggle("hidden",!g))}return v}.apply(k,D),C!==void 0&&(K.exports=C)},28721:(K,k,s)=>{var D,C;D=[s(29930)],C=function(A){var E={},S,T;E.init=function(c,r){var n=c.find(".tags");if(n.length){S=ajaxify.data.hasOwnProperty("minTags")?ajaxify.data.minTags:config.minimumTagsPerTopic,T=ajaxify.data.hasOwnProperty("maxTags")?ajaxify.data.maxTags:config.maximumTagsPerTopic,n.tagsinput({tagClass:"badge bg-info rounded-1",confirmKeys:[13,44],trimValue:!0});var d=c.find(".bootstrap-tagsinput input");v(c,r,ajaxify.data),app.loadJQueryUI(function(){d.autocomplete({delay:100,position:{my:"left bottom",at:"left top",collision:"flip"},appendTo:c.find(".bootstrap-tagsinput"),open:function(){$(this).autocomplete("widget").css("z-index",2e4)},source:function(y,P){socket.emit("topics.autocompleteTags",{query:y.term,cid:r.cid},function(L,a){if(L)return A.error(L);a&&P(a),$(".ui-autocomplete a").attr("data-ajaxify","false")})},select:function(){f(d)}}),M(r.tags,n),n.on("beforeItemAdd",function(y){var P=T&&T<=E.getTags(c.attr("data-uuid")).length,L=utils.cleanUpTag(y.item,config.maximumTagLength),a=L!==y.item;if(y.cancel=a||y.item.length<config.minimumTagLength||y.item.length>config.maximumTagLength||P,y.item.length<config.minimumTagLength)return A.error("[[error:tag-too-short, "+config.minimumTagLength+"]]");if(y.item.length>config.maximumTagLength)return A.error("[[error:tag-too-long, "+config.maximumTagLength+"]]");if(P)return A.error("[[error:too-many-tags, "+T+"]]");a&&n.tagsinput("add",L)});var m=!1,x=!1;n.on("itemRemoved",function(y){if(x){x=!1;return}y.item&&socket.emit("topics.canRemoveTag",{tag:y.item},function(P,L){if(P)return A.error(P);L||(A.error("[[error:cant-remove-system-tag]]"),m=!0,n.tagsinput("add",y.item))})}),n.on("itemAdded",function(y){if(m){m=!1;return}var P=r.hasOwnProperty("cid")?r.cid:ajaxify.data.cid;socket.emit("topics.isTagAllowed",{tag:y.item,cid:P||0},function(L,a){if(L)return A.error(L);if(!a)return x=!0,n.tagsinput("remove",y.item);$(window).trigger("action:tag.added",{cid:P,tagEl:n,tag:y.item}),d.length&&d.autocomplete("close")})})}),d.attr("tabIndex",n.attr("tabIndex")),d.on("blur",function(){f(d)}),$('[component="composer/tag/dropdown"]').on("click","li",function(){var m=$(this).attr("data-tag");return m&&M([m],n),!1})}},E.isEnoughTags=function(c){return E.getTags(c).length>=S},E.minTagCount=function(){return S},E.onChangeCategory=function(c,r,n,d){var m=c.find('[component="composer/tag/dropdown"]');m.length&&(v(c,r,d),m.toggleClass("hidden",!d.tagWhitelist||!d.tagWhitelist.length),d.tagWhitelist&&app.parseAndTranslate("composer","tagWhitelist",{tagWhitelist:d.tagWhitelist},function(x){m.find(".dropdown-menu").html(x)}))};function v(c,r,n){var d=c.find(".tags"),m=c.find(".bootstrap-tagsinput input");m.length&&(n.hasOwnProperty("minTags")&&(S=n.minTags),n.hasOwnProperty("maxTags")&&(T=n.maxTags),n.tagWhitelist&&n.tagWhitelist.length?(m.attr("readonly",""),m.attr("placeholder",""),d.tagsinput("items").slice().forEach(function(x){n.tagWhitelist.indexOf(x)===-1&&d.tagsinput("remove",x)})):(m.removeAttr("readonly"),m.attr("placeholder",c.find("input.tags").attr("placeholder"))),c.find(".tags-container").toggleClass("haswhitelist",!!(n.tagWhitelist&&n.tagWhitelist.length)),c.find(".tags-container").toggleClass("hidden",n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]||T===0&&!r&&!r.tags&&!r.tags.length),n.privileges&&n.privileges.hasOwnProperty("topics:tag")&&!n.privileges["topics:tag"]&&d.tagsinput("removeAll"),$(window).trigger("action:tag.toggleInput",{postContainer:c,tagWhitelist:n.tagWhitelist,tagsInput:m}))}function f(c){var r=jQuery.Event("keypress");r.which=13,r.keyCode=13,setTimeout(function(){c.trigger(r)},100)}function M(c,r){if(c&&c.length)for(var n=0;n<c.length;++n)r.tagsinput("add",c[n])}return E.getTags=function(c){return $('.composer[data-uuid="'+c+'"] .tags').tagsinput("items")},E}.apply(k,D),C!==void 0&&(K.exports=C)},36244:(K,k,s)=>{var D,C;D=[s(89596),s(13342),s(17459),s(29930),s(43103),s(64061)],C=function(A,E,S,T,v){var f={inProgress:{}},M="";f.initialize=function(a){d(a),m(a),c(a),r(a),S.translate("[[modules:composer.uploading, 0%]]",function(l){M=l})};function c(a){var l=$('.composer[data-uuid="'+a+'"]');l.find("#files").on("change",function(p){var W=(p.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);W&&P({files:W,post_uuid:a,route:"/api/post/upload"})})}function r(a){var l=$('.composer[data-uuid="'+a+'"]');l.on("click",".topic-thumb-clear-btn",function(p){l.find("input#topic-thumb-url").val("").trigger("change"),n(l.find("input#topic-thumb-file")),$(this).addClass("hide"),p.preventDefault()}),l.on("paste change keypress","input#topic-thumb-url",function(){var p=$(this);setTimeout(function(){var W=p.val();W?l.find(".topic-thumb-clear-btn").removeClass("hide"):(n(l.find("input#topic-thumb-file")),l.find(".topic-thumb-clear-btn").addClass("hide")),l.find("img.topic-thumb-preview").attr("src",W)},100)})}function n(a){a.wrap("<form />").closest("form").get(0).reset(),a.unwrap()}function d(a){var l=$('.composer[data-uuid="'+a+'"]');v.handleDragDrop({container:l,callback:function(p){P({files:p.files,post_uuid:a,route:"/api/post/upload",formData:p.formData})}})}function m(a){var l=$('.composer[data-uuid="'+a+'"]');v.handlePaste({container:l,callback:function(p){P({files:p.files,fileNames:p.fileNames,post_uuid:a,route:"/api/post/upload",formData:p.formData})}})}function x(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function y(a,l,p){return a.slice(0,l)+p+a.slice(l)}function P(a){var l=[...a.files],p=a.post_uuid,W=$('.composer[data-uuid="'+p+'"]'),F=W.find("textarea"),i=F.val(),j=W.find("#fileForm"),G=!1;j.attr("action",config.relative_path+a.route);var g=E.getSelectedCid();!g&&ajaxify.data.cid&&(g=ajaxify.data.cid);var u=0,b=!1;for(u=0;u<l.length;++u)if(b=l[u].type.match(/image./),b&&!app.user.privileges["upload:post:image"]||!b&&!app.user.privileges["upload:post:file"])return T.error("[[error:no-privileges]]");var V=[];let ie="";for(u=0;u<l.length;++u){if(V.push(u+"_"+Date.now()+"_"+(a.fileNames?a.fileNames[u]:l[u].name)),b=l[u].type.match(/image./),!app.user.isAdmin&&l[u].size>parseInt(config.maximumFileSize,10)*1024)return j[0].reset(),T.error("[[error:file-too-big, "+config.maximumFileSize+"]]");ie+=(b?"!":"")+"["+V[u]+"]("+M+") "}const ne=F.getCursorPosition(),re=i.length;i=y(i,ne,ie),j.length&&W.find('[data-action="post"]').prop("disabled",!0),F.val(i),$(window).trigger("action:composer.uploadStart",{post_uuid:p,files:V.map(function(Z,B){return{filename:Z.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(l[B].type)}}),text:M}),j.off("submit").submit(function(){function Z(B,O,R){var q;R&&(q=B.replace(/^\d+_\d{13}_/,""));var ee=F.val(),e=new RegExp(x(B)+"]\\([^)]+\\)","g");F.val(ee.replace(e,(q||B)+"]("+O+")")),$(window).trigger("action:composer.uploadUpdate",{post_uuid:p,filename:B,text:O})}return f.inProgress[p]=f.inProgress[p]||[],f.inProgress[p].push(1),a.formData&&a.formData.append("cid",g),$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:a.formData,data:{cid:g},error:function(B){G=!0,W.find('[data-action="post"]').prop("disabled",!1);const O=L(B,p);for(var R=0;R<l.length;++R)Z(V[R],O,!0);A.render(W)},uploadProgress:function(B,O,R,q){S.translate("[[modules:composer.uploading, "+q+"%]]",function(ee){if(!G)for(var e=0;e<l.length;++e)Z(V[e],ee)})},success:function(B){const O=B.response.images;if(G=!0,O&&O.length)for(var R=0;R<O.length;++R)O[R].filename=V[R].replace(/^\d+_\d{13}_/,""),O[R].isImage=/image./.test(l[R].type),Z(V[R],O[R].url,!0);A.render(W),F.prop("selectionEnd",ne+F.val().length-re),F.focus(),W.find('[data-action="post"]').prop("disabled",!1),$(window).trigger("action:composer.upload",{post_uuid:p,files:O})},complete:function(){j[0].reset(),f.inProgress[p].pop()}}),!1}),j.submit()}function L(a,l){var p=a.responseJSON&&(a.responseJSON.error||a.responseJSON.status&&a.responseJSON.status.message)||"[[error:parse-error]]";return a&&a.status===413&&(p=a.statusText||"Request Entity Too Large"),T.error(p),$(window).trigger("action:composer.uploadError",{post_uuid:l,message:p}),p}return f}.apply(k,D),C!==void 0&&(K.exports=C)}}]);
