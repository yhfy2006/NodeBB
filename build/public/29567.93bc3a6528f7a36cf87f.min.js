(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[29567,87212],{74566:(g,h,r)=>{g.exports=r(12236)},68636:(g,h,r)=>{"use strict";var m;m=function(){function c(){this._store={},this._keys=[]}c.prototype.isMock=!0,c.prototype.setItem=function(t,p){t=String(t),this._keys.indexOf(t)===-1&&this._keys.push(t),this._store[t]=p},c.prototype.getItem=function(t){return t=String(t),this._keys.indexOf(t)===-1?null:this._store[t]},c.prototype.removeItem=function(t){t=String(t),this._keys=this._keys.filter(function(p){return p!==t}),this._store[t]=null},c.prototype.clear=function(){this._keys=[],this._store={}},c.prototype.key=function(t){return t=parseInt(t,10)||0,this._keys[t]},Object.defineProperty&&Object.defineProperty(c.prototype,"length",{get:function(){return this._keys.length}});let l;const u=Date.now().toString();try{if(l=window.localStorage,l.setItem(u,u),l.getItem(u)!==u)throw Error("localStorage behaved unexpectedly");return l.removeItem(u),l}catch(t){console.warn(t),console.warn("localStorage failed, falling back on sessionStorage");try{if(l=window.sessionStorage,l.setItem(u,u),l.getItem(u)!==u)throw Error("sessionStorage behaved unexpectedly");return l.removeItem(u),l}catch(p){return console.warn(p),console.warn("sessionStorage failed, falling back on memory storage"),new c}}}.call(h,r,h,g),m!==void 0&&(g.exports=m)},12236:(g,h,r)=>{"use strict";var m,c;m=[r(49897),r(29930)],c=function(l,u){const t={};t.init=function(e,n){const o=e.find(".draft-icon"),s=e.attr("data-uuid");function i(){$(`[component="composer"][data-uuid="${s}"]`).length&&(n.save_id||(n.save_id=utils.generateSaveId(app.user.uid)),t.addToDraftList("available",n.save_id),t.addToDraftList("open",n.save_id),I(e,o,n))}e.on("keyup","textarea, input.handle, input.title",utils.debounce(i,1e3)),e.on("click",'input[type="checkbox"]',utils.debounce(i,1e3)),e.on("click",'[component="category/list"] [data-cid]',utils.debounce(i,1e3)),e.on("itemAdded",".tags",utils.debounce(i,1e3)),e.on("thumb.uploaded",i),o.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const a=t.getList("open");a.length&&a.forEach(f=>t.removeFromDraftList("open",f))}),t.migrateGuest(),t.migrateThumbs(...arguments)};function S(e){return parseInt(e,10)>0?localStorage:sessionStorage}t.get=function(e){if(!e)return null;const n=e.split(":")[1],o=S(n);try{const s=o.getItem(e),i=JSON.parse(s)||null;if(!i)throw new Error(`can't parse draft json for ${e}`);return i.save_id=e,i.timestamp&&(i.timestampISO=utils.toISOString(i.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:e,draft:i,storage:o}),i}catch{return console.warn(`[composer/drafts] Could not get draft ${e}, removing`),t.removeFromDraftList("available"),t.removeFromDraftList("open"),null}};function I(e,n,o){if(v(app.user.uid?"localStorage":"sessionStorage")&&o&&o.save_id&&e.length){const s=e.find("input.title"),i=s&&s.length&&s.val(),a=e.find("textarea").val(),f=S(app.user.uid);if(a.length||i&&i.length){const d={save_id:o.save_id,action:o.action,text:a,uuid:e.attr("data-uuid"),timestamp:Date.now()};if(o.action==="topics.post"){const E=e.find("input.tags").val();d.tags=E,d.title=i,d.cid=o.cid}else o.action==="posts.reply"?(d.title=o.title,d.tid=o.tid,d.toPid=o.toPid):o.action==="posts.edit"&&(d.pid=o.pid,d.title=i||o.title);app.user.uid||(d.handle=e.find("input.handle").val()),f.setItem(o.save_id,JSON.stringify(d)),$(window).trigger("action:composer.drafts.save",{storage:f,postData:o,postContainer:e}),n.toggleClass("active",!0)}else t.removeDraft(o.save_id)}}t.removeDraft=function(e){if(!e)return;t.removeFromDraftList("available",e),t.removeFromDraftList("open",e);const n=e.split(":")[1],o=S(n);o.removeItem(e),$(window).trigger("action:composer.drafts.remove",{storage:o,save_id:e})},t.getList=function(e){try{const n=localStorage.getItem(`drafts:${e}`);return JSON.parse(n)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},t.addToDraftList=function(e,n){if(!v(app.user.uid?"localStorage":"sessionStorage")||!n)return;const o=t.getList(e);o.includes(n)||(o.push(n),localStorage.setItem("drafts:"+e,JSON.stringify(o)))},t.removeFromDraftList=function(e,n){if(!v(app.user.uid?"localStorage":"sessionStorage")||!n)return;const o=t.getList(e);o.includes(n)&&(o.splice(o.indexOf(n),1),localStorage.setItem("drafts:"+e,JSON.stringify(o)))},t.migrateGuest=function(){if(v("localStorage")&&app.user.uid){const e=/^composer:\d+:\d$/,n=Object.keys(sessionStorage).filter(function(i){return e.test(i)}),o=new Set([]),s=n.map(function(i){const a=i.split(":");return a[1]=app.user.uid,o.add(a.join(":")),a.join(":")});return n.forEach(function(i,a){localStorage.setItem(s[a],sessionStorage.getItem(i)),sessionStorage.removeItem(i)}),o.forEach(function(i){t.addToDraftList("available",i)}),o}},t.migrateThumbs=function(e,n){if(!app.uid)return;const o=e.attr("data-uuid"),s=t.get(n.save_id);s&&s.uuid&&l.put(`/topics/${s.uuid}/thumbs`,{tid:o}).then(()=>{Promise.all([r.e(23662),r.e(65285),r.e(54516),r.e(99166),r.e(47061),r.e(11484)]).then(function(){var i=[r(71431)];(function(a){a.updateThumbCount(o,e)}).apply(null,i)}).catch(r.oe)})},t.listAvailable=function(){return t.getList("available").map(t.get).filter(Boolean)},t.getAvailableCount=function(){return t.listAvailable().length},t.open=function(e){if(!e)return;const n=t.get(e);y(e,n)},t.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const e=t.getList("available"),n=t.getList("open");e.length&&e.forEach(function(o){if(!o||n.includes(o))return;const s=t.get(o);if(!s||!s.text&&!s.title){t.removeFromDraftList("available",o),t.removeFromDraftList("open",o);return}y(o,s)})};function y(e,n){const s=e.split(":")[1];parseInt(app.user.uid,10)===parseInt(s,10)&&Promise.all([r.e(23662),r.e(65285),r.e(54516),r.e(99166),r.e(47061),r.e(11484)]).then(function(){var i=[r(71431)];(function(a){n.action==="topics.post"?a.newTopic({save_id:n.save_id,cid:n.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(n.handle),title:utils.escapeHTML(n.title),body:n.text,tags:String(n.tags||"").split(",")}):n.action==="posts.reply"?l.get("/topics/"+n.tid,{},function(f,d){if(f)return u.error(f);a.newReply({save_id:n.save_id,tid:n.tid,toPid:n.toPid,title:d.title,body:n.text})}):n.action==="posts.edit"&&a.editPost({save_id:n.save_id,pid:n.pid,title:n.title?utils.escapeHTML(n.title):void 0,body:n.text})}).apply(null,i)}).catch(r.oe)}function v(e){var n;try{n=window[e];var o="__storage_test__";return n.setItem(o,o),n.removeItem(o),!0}catch(s){return s instanceof DOMException&&(s.code===22||s.code===1014||s.name==="QuotaExceededError"||s.name==="NS_ERROR_DOM_QUOTA_REACHED")&&n&&n.length!==0}}return t}.apply(h,m),c!==void 0&&(g.exports=c)}}]);
